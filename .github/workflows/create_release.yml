name: Docker Image Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release and images'
        required: true
      name:
        description: 'Release name (optional)'
        required: false
      body:
        description: 'Release notes body (optional)'
        required: false
      prerelease:
        description: 'Mark release as prerelease (true/false)'
        required: false
        default: 'false'

jobs:
  build-images:
    strategy:
      fail-fast: true
      matrix:
        platform:
          # - [X64, linux/amd64]
          - [ARM64, linux/arm64]
        image:
          - develop
          # - thor
          - orin
        exclude:
          - platform: X64
            image: thor
          - platform: X64
            image: orin


    name: Build ${{ matrix.image }} on ${{ matrix.platform[0] }}
    runs-on: 
    - self-hosted
    - ${{ matrix.platform[0] }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: login to docker registry
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}

      - name: build and push docker image to registry
        uses: docker/build-push-action@v5
        with:
          platforms: ${{ matrix.platform[1] }}
          push: true
          tags: coalman321/tbd-racer:${{ github.event.inputs.tag }}-${{matrix.image}}-${{matrix.platform[0]}}
          file: dockerfiles/tbd-racer-${{matrix.image}}.dockerfile

          # Disable caching for release
          cache-from: type=inline
          cache-to: type=inline

  create-release:
    needs: build-images
    runs-on:
      - self-hosted
      - ARM64
    permissions:
      contents: write
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.name }}
          body: ${{ github.event.inputs.body }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}